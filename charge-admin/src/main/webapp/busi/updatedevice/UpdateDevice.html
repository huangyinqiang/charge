<#include "/common/head.html"/>

<html>
<head>
    <title>Title</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script type="text/javascript" src="${basePath}/res/layer/layer.js"></script>
    <meta charset="UTF-8"/>
    <style type="text/css">
        body{
            background-color: #EBF1F2;
            padding: 0 0 0 2%;
        }

        @media screen and (max-width:468px) {
            body{
                background-color: #EBF1F2;
                padding: 0 0 0 0;
            }
        }
        a {
            text-decoration: none;
        }

        a[class="button-selectimg"], input[type='button'] {
            color: #00A2D4;
            padding: 10px 14px;
            border: 2px dashed #00A2D4;
            border-radius: 2px;
        }
        input[id="avatval"] {
            padding: 6px 12px;
            padding-left: 20px;
            border: 1px solid #E7EAEC;
            width: 300px;
            height: 45px;
            line-height: 50px;
            border-left: 6px solid #3FB7EB;
            background: #FAFAFB;
            border-radius: 4px;
        }

        input[type='file'] {
            border: 0px;
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div style="margin:10px;">
        <div>
            <h2>升级文件</h2>

            <tr >

                <td><input type="text" id="avatval" placeholder="请选择文件···" readonly="readonly" style="vertical-align: middle;"/>
                    <input type="file" name="file" id="avatar" accept="application/octet-stream"/>
                   <!-- <a href="javascript:void(0);" class="button-selectimg" id="avatsel">选择文件</a>--></td>
                <td><input type="button" id="submit" value="文件上传"/></td>

                <td><input type="button" id="update" value="升级"  /></td>
               <!-- <td id="selectAllTd">全选:<input type="checkbox" id="selectAll" class="bs-checkbox"></td>-->
            </tr>

        </div>



<!--        <table class="table table-striped table-hover table-bordered">
            <thead>
            <tr>
                <th class="col-sm-2">编号</th>
                <th class="col-sm-4">电站名</th>
                <th class="col-sm-2">网关编号</th>
                <th id="selectTh" class="col-sm-2">网关</th>
            </tr>
            </thead>
            <tbody>

            <tr id="location">
                <td><input type="button" id="submit" value="提交升级"/></td>
                <td><input type="text" id="avatval" placeholder="请选择文件···" readonly="readonly" style="vertical-align: middle;"/>
                    <input type="file" name="file" id="avatar" accept="application/octet-stream"/>
                    <a href="javascript:void(0);" class="button-selectimg" id="avatsel">选择文件</a></td>
                <td></td>
                <td id="selectAllTd">全选:<input type="checkbox" id="selectAll" class="bs-checkbox"></td>
            </tr>
            </tbody>
        </table>-->
    </div>
</div>
<table id="dg"></table>


</button>



<script type="text/javascript">
    var datagrid = $("#dg");
    var dgOptions = {
        rownumbers : true,
        fit : true,
        border : false,
        rownumbers : true,
        url : 'listData',
        method : 'post',
        toolbar : '#tb',
        pageSize : 50,
        pagination : true,
        multiSort : true,
        singleSelect : false,
        queryParams : getInitParam(),
        columns : [ [
            {
                field : 'id',
                checkbox : true
            },
            {
                field : 'status',
                title : '状态',
                width : 60,
                sortable : true,
                formatter : function(value, row, index) {
                    if (value == '1') {
                        return "<span style='color:green;font-size:20px;'>正常</span>";
                    } else if (value == '2') {
                        return "<span style='color:red;font-size:20px;'>离线</span>";
                    } else {
                        return "<span style='color:yellow;font-size:20px;'>故障</span>";
                    }
                }
            },
            {
                field : 'sn',
                title : 'SN编号',
                width : 60,
            },
            {
                field : 'name',
                title : '名称',
                width : 60,
            },
            {
                field : 'province',
                title : '省',
                width : 60,
            },
            {
                field : 'city',
                title : '市',
                width : 60,
            },
            {
                field : 'detail_location',
                title : '详细位置信息',
                width : 120,
            },
            {
                field : 'lat',
                title : '经度',
                width : 60,
            },
            {
                field : 'lng',
                title : '纬度',
                width : 60,
            },
            {
                field : 'power_max',
                title : '最大功率',
                width : 60,
            },
            {
                field : 'socket_sum',
                title : '插座数量',
                width : 60,
            },
            {
                field : 'company_id',
                title : '公司id',
                width : 60,
            },
            {
                field : 'total_intensity',
                title : '总电流',
                width : 60,
            },
            {
                field : 'total_voltage',
                title : '总电压',
                width : 60,
            },
            {
                field : 'is_online',
                title : '是否上线',
                width : 60,
                formatter : function(value, row, index) {
                    if (value == '1') {
                        return "<span style='color:green;font-size:20px;'>启用</span>";
                    } else  {
                        return "<span style='color:red;font-size:20px;'>未上线</span>";
                    }
                }
            }, {
                field : 'online_date',
                title : '上线时间',
                width : 120,
                sortable : true
            },
            {
                field : 'update_time',
                title : '更新时间',
                width : 120,
                sortable : true
            }
        ] ]
    };
    $(function() {
        handleAuthDataRule();
        datagrid.datagrid(dgOptions);
    });

    function zcurdGetParam() {
        var param = {};
        $("#tb :input[name]").each(function(i, item) {
            if ($(item).val()) {
                param[$(item).attr("name")] = $(item).val();
            }
        });
        return param;
    }
    function getInitParam() {
        var param = {};
        $("#tb :input[name]").each(
            function(i, item) {
                if ($(item).val()) {
                    param["queryParams[" + $(item).attr("name") + "]"] = $(
                        item).val();
                }
            });
        return param;
    }
</script>









<script type="text/javascript">
    $(document).ready(function(){
        $("#avatsel").click(function () {
            $("input[type='file']").trigger('click');
        });
        $("#avatval").click(function () {
            $("input[type='file']").trigger('click');
        });
        $("input[type='file']").change(function () {
            $("#avatval").val($(this).val().split("\\")[2]);
        });

        $("#selectAll").change(function(){
            var flag = $("#selectAll").prop("checked");
            if (flag){
                $('.box').prop("checked",true);
            }else {
                $('.box').prop("checked",false);
            }
        });


        var update_success=false;
        $("#submit").click(function(){
            var fileVal = $("#avatval").val();
            if(fileVal === "" | fileVal === null){
                alert("请选择升级文件!");
                return;
            }
            var formData = new FormData();               //新建FormData对象
            var fileList = $("#avatar").prop("files");   //取file控件中的文件,files属性取到的是一个fileList
            formData.append('file', fileList[0]);        //将fileList中的文件逐个放入formData中，注意，直接放入fileList后台是取不到的
            var fileName=$("#avatval").val();

            $.ajax({
                url: "updateDeviceData?fileName="+fileName,    //C# Razor写法,也可写成/home/receive,但是安全性欠佳
                data: formData,
                type: 'POST',
                contentType: false,                      //这里着重强调contentType和processData都要设置为false,否则文件发送不过去
                processData: false,                      //这样做是为了防止浏览器自动转换发送出的数据格式为字符串或其他
                success: function (data) {
                    if (data === "OK") {
                        update_success=true;
                        alert("文件上传成功！!");
                    }else {
                        alert("升级错误!");
                    }
                },
                error:function(){
                    alert("error");
                }
            })
        });

        $("#update").click(function(){
            if (!update_success) {
                alert("请先上传文件！!");
                return;
            }
            var rowsSel = datagrid.datagrid("getSelections");
            if (rowsSel.length < 1) {
                showWarnMsg("请选择要编辑的数据！");
                return;
            }
            layer.open({
                title: '在线调试'
                ,content: '<div id="updateMessageDiv"><span >升级中！！！</span></div>'
            });
            $("#updateMessageDiv").append("<br><span >总数："+rowsSel.length+"</span>");
            for(var i= 0;i<rowsSel.length;i++){
                var id =rowsSel[i].id;
                $("#updateMessageDiv").append("<br><span >"+rowsSel[i].name+":  正在升级</span>");
                getUpdateStatus(id,rowsSel[i].name);
            }
        });


        function getUpdateStatus(id,name) {
            $.ajax({
                url: "updateDeviceProcess",
                type: 'POST',
                cache:false,
                data:{
                    "chargePileId":id,
                    "filename":$("#avatval").val(),
                },
                timeout:10*60*1000,
                success: function (data) {
                    var tem = "";
                    switch (data) {
                        case "1":
                            tem = "升级成功";
                            break;
                        case "3":
                            tem = "子站网关处于电池供电,退出更新!";
                            break;
                        case "4":
                            tem = "flash损坏,不可升级!";
                            break;
                        case "5":
                            tem = "版本已最新,无需升级!";
                            break;
                        case "10":
                            tem = "升级成功!";
                            break;
                        case "11":
                            tem = "升级失败!";
                            break;
                        case "12":
                            tem = "其他用户正在升级，请勿操作!";
                            break;
                        case "13":
                            tem = "等待超时,升级失败!";
                            break;
                        case "14":
                            tem = "其他错误,升级失败!";
                            break;
                    }
                    $("#updateMessageDiv").append("<br><span > "+name　+":  " +tem+"</span>");
                },
                error:function(){
                    $("#updateMessageDiv").append("<br><span > "+name　+":  升级失败,其他错误!"+"</span>");
                }
            })
        }
    })
</script>
</body>
</html>
