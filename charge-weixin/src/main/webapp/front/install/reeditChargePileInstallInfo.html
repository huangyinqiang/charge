<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>安装信息编辑</title>
<link rel="stylesheet" href="../css/weui.css">
<link rel="stylesheet" href="../css/wechat.css">
<style>
.codePay-inner table {
	background: #FFFFFF;
	width: 100%;
	margin-top: 10px;
}

.codePay-inner tr {
	height: 50px;
	display: block;
	line-height: 50px;
}

.codePay-inner tr {
	border-bottom: 1px solid #e4e4e4;
}

.codePay-inner tr:last-child {
	border-bottom: none;
}

.codePay-inner tr td {
	padding-left: 10px;
}

.codePay-inner tr td:first-child {
	width: 30%;
}

.codePay-inner input {
	border: medium;
	font-size: 15px;
	height: 40px;
	outline: none;
}

.recharge {
	display: block;
	margin: 0 auto;
	margin-top: 50px;
	text-align: center;
	width: 90%;
	height: 50px;
	line-height: 50px;
	background: #5bc0de;
	color: #FFFFFF;
	border-radius: 20px;
}
</style>
<script type="text/javascript" src="../js/common/jquery-2.1.1.min.js"></script>
<script src="../js/common/layer/layer.js"></script>
<link rel="stylesheet" href="../js/common/layer/theme/default/layer.css">
<script type="text/javascript">


    var deviceId;
    var latitude;
    var longitude;
    var openId;

	$(function() {
        openId = localStorage.getItem("openId");
        deviceId = GetQueryString('deviceId');
        latitude = GetQueryString('latitude');
        longitude = GetQueryString('longitude');

		$.ajax({
			type : "post",
			url : "../newDevice/getAllCompany",
			data : {
			},
			cache : false,
			async : false,//
			dataType : "json",
			success : function(data) {

                if (data.respObj != null && data.respCode == "000000") {
                    var companies = data.respObj;

                    for(var i=0; i<=companies.length; i++){
                        var companyInfo = companies[i];
                        var string="<option  value='" + companyInfo.id + "'>" + companyInfo.company_name + "</option>" ;//+

						$("#company").append(string);

                    }

                } else {

                }
			}
		});


        $("#deviceId").val(deviceId) ;

        getProjectInfo($('#company').val());

	});
    function getProjectInfo(companyId) {

        $("#project").empty();

        if (companyId == "" || companyId == null) {
            return;
        }

        $.ajax({
            type : "post",
            url : "../newDevice/getProjectByCompanyId",
            data : {
                companyId : companyId
            },
            cache : false,
            async : false,//
            dataType : "json",
            success : function(data) {

                if (data.respObj != null && data.respCode == "000000") {
                    var projects = data.respObj;

                    for(var i=0; i<=projects.length; i++){
                        var projectInfo = projects[i];
                        var string="<option  value='" + projectInfo.id + "'>" + projectInfo.name + "</option>" ;//+

                        $("#project").append(string);

                    }

                } else {

                }
            }
        });

    }

	function submit() {

        var chargePileName = $('#chargePileName').val();
        var province = $('#province').val();
        var city = $('#city').val();
        var location = $('#location').val();
        var powerMax = $('#powerMax').val();
        var socketSum = $('#socketSum').val();
        var companyId = $('#company').val();
        var projectId = $('#project').val();
        var iccid = $('#iccid').val();


        if (chargePileName == "" || chargePileName == null) {
            layer.msg("请输入充电桩名称", {
                shift : 5
            });
            return;
        }

        if (province == "" || province == null) {
            layer.msg("请输入充电桩所在省", {
                shift : 5
            });
            return;
        }

        if (city == "" || city == null) {
            layer.msg("请输入充电桩所在市", {
                shift : 5
            });
            return;
        }

        if (location == "" || location == null) {
            layer.msg("请输入充电桩详细地址", {
                shift : 5
            });
            return;
        }

        if (powerMax == "" || powerMax == null) {
            layer.msg("请输入充电桩所最大功率", {
                shift : 5
            });
            return;
        }

        if (socketSum == "" || socketSum == null) {
            layer.msg("请输入充电桩插座总数", {
                shift : 5
            });
            return;
        }

        if (companyId == "" || companyId == null) {
            layer.msg("请选择充电桩运营商", {
                shift : 5
            });
            return;
        }

        if (projectId == "" || projectId == null) {
            layer.msg("请选择充电桩所属项目", {
                shift : 5
            });
            return;
        }
        if (iccid == "" || iccid == null) {
            layer.msg("请输入物联卡号", {
                shift : 5
            });
            return;
        }


		$.ajax({
			type : "post",
			url : "../newDevice/permissionOnlineAndUpdate",
			data : {
				openId : localStorage.getItem("openId"),
                deviceId: deviceId,
                chargePileName : chargePileName,
                province : province,
         		city : city,
                location : location,
                latitude : latitude,
                longitude : longitude,
                powerMax : powerMax,
                socketSum : socketSum,
                companyId : companyId,
                projectId : projectId,
                iccid : iccid
    		},
			cache : false,
			async : false,//
			dataType : "json",
            beforeSend : function(){
                // $("#submit").text('数据正在上传，请稍候...');
                // $('#submit').prop("disabled", true);
            },
            complete: function(){
                // 设置 进度条到80%
                // $('#submit').prop("disabled", true);
                // $("#submit").text('数据上传完成');
            },
			success : function(data) {

			    console.log(data);

                if ( data.respCode == "000000"){
                    layer.msg("入网成功", {
                        shift : 5
                    });
                    window.location.href = "../index"
				}else {
                    $('#submit').prop("disabled", false);
                    $("#submit").text('尝试再次提交');
                    layer.msg(data.respMsg, {
                        shift : 5
                    });
                }
			}
		});
	}
    // 获取URL中的参数值
    function GetQueryString(url) {
        var reg = new RegExp("(^|&)" + url + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null)
            return unescape(r[2]);
        return null;
    }

</script>
</head>

<body>
	<div class="container">
		<div class="codePay-inner ">
			<table>

				<tr>
					<td style="width: 120px;">设备ID</td>
					<td><input disabled align="right" type="text"  id="deviceId"></input></td>
				</tr>
				<tr>
				<td style="width: 120px;">充电桩名称</td>
				<td><input align="right" type="text" placeholder="小区名称+设备编号" id="chargePileName"></input></td>
				</tr>

				<tr>
					<td style="width: 120px;">省</td>
					<td><input align="right" type="text" placeholder="请输入设备所在省" id="province"></input></td>
				</tr>

				<tr>
					<td style="width: 120px;">市</td>
					<td><input align="right" type="text" placeholder="请输入设备所在市" id="city"></input></td>
				</tr>

				<tr>
					<td style="width: 120px;">详细地址</td>
					<td><input align="right" type="text" placeholder="请输入设备详细地址" id="location"></input></td>
				</tr>

				<tr>
					<td style="width: 120px;">最大功率 KW</td>
					<td><input align="right" type="text" placeholder="请输入设备最大功率" id="powerMax"></input></td>
				</tr>

				<tr>
					<td style="width: 120px;">插座总数</td>
					<td><input align="right" type="text" placeholder="请输入设备插座总数" id="socketSum"></input></td>
				</tr>

				<tr>
					<td style="width: 120px;">运营商</td>
					<td>
						<select  class="form-control" id="company" name="company"
								 placeholder="请选择运营商" onchange="getProjectInfo($('#company').val())" >

						</select>
					</td>
				</tr>

				<tr>
					<td style="width: 120px;">项目名称</td>
					<td>
						<select  class="form-control" id="project" name="project"
								 placeholder="请选择项目">

						</select>
					</td>
				</tr>
                <tr>
                    <td style="width: 120px;">ICCID</td>
                    <td><input align="right" type="text" placeholder="物联卡背后20位" id="iccid" /></td>
                </tr>

			</table>
			<a id="submit" href="#" onclick="submit()" class="recharge">提交</a>
		</div>
	</div>
</body>
<script src="../js/common/zepto.min.js"></script>
<script src="../js/common/weui.min.js"></script>
</html>                           