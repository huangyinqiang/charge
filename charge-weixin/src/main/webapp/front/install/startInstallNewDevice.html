<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
<meta name="format-detection" content="telphone=no,email=no" />
<meta name="keywords" content="">
<meta name="description" content="">
<title>设备安装</title>
<link rel="stylesheet" type="text/css" href="temp/main.css">
<script type="text/javascript" src="temp/jquery.js"></script>
<!--<script type="text/javascript" src="js/charging/startCharging.js"></script>-->
<script src="js/common/layer/layer.js"></script>
<link rel="stylesheet" href="js/common/layer/theme/default/layer.css">
<script type="text/javascript"
	src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">


    var localUrl = window.location.href;
    var openId;
    var latitude = 34.123453;
    var longitude = 108.89876;

    $(function() {
        openId = localStorage.getItem("openId");// 获取名称为“key”的值
        if (null == openId) {
            getOpenId();
        }
        getJsSdk();
    });
    function getJsSdk() {
        $.ajax({
            type : "POST",
            url : "./scan/getJsSdk",
            data : {
                url : localUrl
            },
            cache : false,
            async : false,//
            dataType : "json",
            success : function(data) {
                wx.config({
                    debug : false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId : data.appId, // 必填，公众号的唯一标识
                    timestamp : data.timestamp, // 必填，生成签名的时间戳
                    nonceStr : data.nonceStr, // 必填，生成签名的随机串
                    signature : data.signature,// 必填，签名，见附录1
                    jsApiList : [ 'scanQRCode','openLocation', 'getLocation' ]
                    // 必填，需要使用的JS接口列表
                });
                wx.ready(function() {
                    wx.getLocation({
                        success : function(res) {
                            latitude = res.latitude;
                            longitude = res.longitude;
                        },
                        fail : function(res) {
                            layer.msg("获取当前位置失败", {
                                shift : 5
                            });
                            return;
                        }
                    });
                });
            }
        });
    }
    // 获取session中的openId
    function getOpenId() {
        $.ajax({
            type : "POST",
            url : "./getOpenId",
            cache : false,// *ie下面只会建立一次 ajax 请求，将响应结果放在浏览器缓存里 下次调用该ajax请求时
            // 从缓存里读取,为false只有ＧＥＴ请求生效
            async : false,// 设置同步方式，false为同步
            dataType : "json",
            success : function(data) {
                if (data.respObj != null && data.respCode == "000000") {
                    openId = data.respObj;
                    localStorage.setItem("openId", data.respObj);// 以“key”为名称存储一个值“value”
                } else {
                    location.href = ".?type=2";
                }
            }
        });
    }

    //扫码查询
    function scanQR(type) {
            wx.scanQRCode({
                needResult : 1,// 默认为0，扫描结果由微信处理，1则直接返回扫描结果
                desc : 'scanQRCode desc',
                success : function(res) {

                    var deviceId = res.resultStr;
                    if(res.resultStr.indexOf("deviceid")>=0 && res.resultStr.indexOf("=")>=0 && res.resultStr.indexOf("?")>=0){

                        var strs = res.resultStr.split("=");
                        deviceId = strs[1];
                    }

                    if (deviceId.length == 11 || deviceId.length == 12) {
                        //新设备
                        queryNewDevice(deviceId, type)
                    }else {
                        layer.msg("错误的设备ID！", {
                            shift : 5
                        });

                        return;
                    }


                }
            });
    }


    // 扫码查询
    function scanQRTest(type) {
        queryNewDevice("201808000011", type);

    }

    function queryNewDevice(deviceId, type) {

        console.log("type = " + type);

        $.ajax({
            type : 'POST',
            url : "./newDevice/getNotifyDeviceInfo",
            dataType : "json",
            data : {
                deviceId: deviceId
            },
            cache : false,
            async : false,
            success : function(data) {
                if (data.respCode != '000000' | null == data.respObj) {
                    layer.msg("设备暂时离线，请稍后再试...", {
                        shift : 5
                    });
                    return;
                }

                if (data.respObj.is_online == 1) {
                    layer.msg("设备已经上线，将会被重新配置数据", {
                        shift : 3
                    });

                    location.href = "./install/editInstallInfo?deviceId="
                        + data.respObj.id + "&latitude=" + latitude + "&longitude=" + longitude  + "&installed=1"
				}else {

                    location.href = "./install/editInstallInfo?deviceId="
                        + data.respObj.id + "&latitude=" + latitude + "&longitude=" + longitude  + "&installed=" + type
				}


            },
            error : function() {

            }
        });
    }

</script>
</head>
<body>

	<div class="top">
		<ul>
			<li><img src="../temp/topNum01.png" alt="1">
				<p>确保您的手机GPS定位功能打开。</p></li>
			<li><img src="../temp/topNum02.png" alt="2">
				<p>点击扫码安装。</p></li>
			<li><img src="../temp/topNum03.png" alt="3">
				<p>根据提示继续操作。</p></li>
		</ul>
	</div>
	<div class="cen">
		<i class="icon" onclick="scanQR('0');"></i>
		<input type="button" onclick="scanQR('0');" value="入网安装">
		<input type="button" onclick="scanQR('1');" value="重新设置">
	</div>
</body>
</html>

