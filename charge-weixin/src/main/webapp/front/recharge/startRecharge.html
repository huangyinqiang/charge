<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>优惠活动</title>
<link rel="stylesheet" href="css/weui.css">
<link rel="stylesheet" href="css/wechat.css">
<script type="text/javascript" src="js/common/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<!--<script type="text/javascript" src="js/recharge/startRecharge.js"></script>-->
<script src="./js/common/layer/layer.js"></script>
<link rel="stylesheet" href="./js/common/layer/theme/default/layer.css">
<script type="text/javascript">
    var localUrl = window.location.href;
    var type;//充值類型
    $(function() {
        var localUrl = window.location.href;
        type = GetQueryString('type');
        $.ajax({
            type : "GET",
            url : "./scan/getJsSdk",
            data : {
                url : localUrl
            },
            cache : false,// *ie下面只会建立一次 ajax 请求，将响应结果放在浏览器缓存里 下次调用该ajax请求时 从缓存里读取,为false只有ＧＥＴ请求生效
            async : false,// 设置同步方式，false为同步
            dataType : "json",
            success : function(data) {
                wx.config({
                    debug : false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId : data.appId, // 必填，公众号的唯一标识
                    timestamp : data.timestamp, // 必填，生成签名的时间戳
                    nonceStr : data.nonceStr, // 必填，生成签名的随机串
                    signature : data.signature,// 必填，签名，见附录1
                    jsApiList : [ 'scanQRCode']
                    // 必填，需要使用的JS接口列表
                });
            }
        });
    });
    //扫码查询
    function scanQR() {
    	wx.scanQRCode({
    		needResult : 1,// 默认为0，扫描结果由微信处理，1则直接返回扫描结果
    		desc : 'scanQRCode desc',
    		success : function(res) {

                var deviceId = res.resultStr;
                if(res.resultStr.indexOf("deviceid")>=0 && res.resultStr.indexOf("=")>=0 && res.resultStr.indexOf("?")>=0){

                    var strs = res.resultStr.split("=");
                    deviceId = strs[1];
                }

                if (deviceId.length == 11 || deviceId.length == 12) {
                    //新设备
                    quereActivityByNewDeviceId(deviceId)
                }else {
                    //老设备直接处理
                    queryDevice(res.resultStr);
                }



    		}
    	});
    }

    function scanQRTest(){

        //todo 测试账号,正式部署使用正常扫码
        quereActivityByNewDeviceId("10100000001");

    }

    // 查询
    function queryDevice(value) {
        $.ajax({
            type : 'GET',
            url : "./device/queryDeviceInfoByQr",
            dataType : "json",
            data : {
                qr : value
            },
            cache : false,// *ie下面只会建立一次 ajax 请求，将响应结果放在浏览器缓存里 下次调用该ajax请求时 从缓存里读取,为false只有ＧＥＴ请求生效
            async : false,// 设置同步方式，false为同步
            success : function(data) {
                if (data.respCode != '000000' | null == data.respObj) {
                    layer.msg("设备暂时离线，请稍后再试...", {
                        shift : 5
                    });
                    return;
                }
                location.href = "./recharge/recharge?deviceId="
                    + data.respObj.match_num + "&area="
                    + encodeURI(encodeURI(data.respObj.area)) + "&activityId="
                    + data.respObj.activity_id + "&type=WA&id="+data.respObj.id;
            },
            error : function() {

            }
        });
    }

    // 查询
    function quereActivityByNewDeviceId(deviceId) {
        $.ajax({
            type : 'GET',
            url : "./newDevice/getDeviceCompanyInfo",
            dataType : "json",
            data : {
                deviceId : deviceId
            },
            cache : false,// *ie下面只会建立一次 ajax 请求，将响应结果放在浏览器缓存里 下次调用该ajax请求时 从缓存里读取,为false只有ＧＥＴ请求生效
            async : false,// 设置同步方式，false为同步
            success : function(data) {
                if (data.respCode != '000000' | null == data.respObj) {
                    layer.msg("设备优惠信息查询有误，请稍后再试...", {
                        shift : 5
                    });
                    return;
                }
                location.href = "./recharge/rechargeNew?companyId=" + data.respObj.company_id+"&projectId="+ data.respObj.projectId+"&deviceId="+deviceId
            },
            error : function() {

            }
        });

    }

    //获取URL中的参数值
    function GetQueryString(url) {
        var reg = new RegExp("(^|&)" + url + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null)
            return unescape(r[2]);
        return null;
    }
</script>
</head>
<body>
	<div class="container">
		<div class="top">
			<div class="page home">
				<div class="page__hd">
					<h1>
						<img src="images/logo.png" class="img-common" alt="">
					</h1>
					<ul>
						<li>请扫描运营商提供的二维码</li>
					</ul>
				</div>
				<div class="panel weui-flex">
					<div class="weui-flex__item text-center">
						<img src="images/cord.png" class="cord" alt="" href="javascript:void(0);" onclick="scanQR('');">
						<p href="javascript:;">扫码获取优惠活动</p>
					</div>

				</div>

			</div>
		</div>
	</div>
</body>
<script src="js/common/zepto.min.js"></script>
<script src="js/common/weui.min.js"></script>
</html>