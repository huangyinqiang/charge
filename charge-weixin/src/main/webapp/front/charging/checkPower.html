<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<!-- 条转到充电记录页面 -->
<!-- <meta http-equiv="refresh" content="10;url=../charging/chargingInfo"> -->
<title>功率检测</title>
<link rel="stylesheet" href="../css/weui.css">
<link rel="stylesheet" href="../css/wechat.css">
<link rel="stylesheet" href="../js/common/layer/mobile/need/layer.css">
<script type="text/javascript" src="../js/common/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="../js/common/leadbase-encrypts.js"></script>
<script src="../js/common/layer/mobile/layer.js"></script>
<script type="text/javascript" src="../js/charging/checkPower.js"></script>
</head>
<body onload="shownum()">
	<div class="container">
		<div class="page__bd">
			<div class="page home">
				<div class="weui-flex">
					<div class="weui-flex__item">
						<div class="charge-cont text-center">
							<img src="../images/testing.png" class="battery-pic" alt="">
							<h3 class="charge-active">功率检测</h3>
							<p>
								<i class="common-color" id="showTimes"></i>
							</p>
							<!-- <a href="../poweroff" class="weui-btn weui-btn_default">
								远程断电 </a> -->
						</div>
					</div>
				</div>
				<div class="show-control">
					<p>
						充电插座：<i id="devicePort"></i>
					</p>
					<p>
						充电时长：<i id="time"></i>分钟
					</p>
                    <p>
                        充电功率：<i id="power">0</i>W
                    </p>
                    <p>
                        充电费用：<i id="money">0</i>元
                    </p>
				</div>
			</div>
		</div>
		
	</div>

	<!--<div id="submitBtn" style="width: 96%;height: auto;position: fixed;bottom: 60px;left:0px;right:0px;margin: auto;">-->
		<!--<a href="javascript:void(0)" class="weui-btn weui-btn_default" onclick="submit()">确认充电 </a>-->
	<!--</div>-->

</body>
<script src="../js/common/zepto.min.js"></script>
<script src="../js/common/weui.min.js"></script>
<script>
    var openId = GetQueryString("openId");
    var companyId = GetQueryString("companyId");
    var type = GetQueryString("type");
    var deviceId = GetQueryString("deviceId");
    var devicePort = GetQueryString("devicePort");
    var temp = GetQueryString("time");
    var time = temp*1;
    temp = GetQueryString("money");
    var money = temp*1;
    temp = GetQueryString("walletAccount");
    var walletAccount = temp*1;
    var operType = GetQueryString("operType");
    temp = GetQueryString("realGiftRate");
    var realGiftRate = temp*1.0;
    temp = GetQueryString("autoUnitPrice");
    var autoUnitPrice = temp*1;
    temp = GetQueryString("power_a1");
    var power_a1 = temp*1;
    temp = GetQueryString("power_a2");
    var power_a2 = temp*1;
    temp = GetQueryString("power_a3");
    var power_a3 = temp*1;
    temp = GetQueryString("power_a4");
    var power_a4 = temp*1;
    temp = GetQueryString("power_a5");
    var power_a5 = temp*1;
    temp = GetQueryString("power_a6");
    var power_a6 = temp*1;
    temp = GetQueryString("power_a7");
    var power_a7 = temp*1;
    temp = GetQueryString("autoPrice");
    var autoPrice = temp*1;
    var power;
    var serverResultDesc;

	var socketIsOpen = false;
	var userIsConfirmed = false;

    setTimeout(startCharge4CheckPower,1000)
    function startCharge4CheckPower() {
        $.ajax({
            type : 'POST',
            url : "../newDevice/startCharge4CheckPower",
            dataType : "json",
            data : {
                openId : GetQueryString("openId"),
                companyId : GetQueryString("companyId"),
                type : GetQueryString("type"),
                deviceId : GetQueryString("deviceId"),
                devicePort : GetQueryString("devicePort"),
                time : GetQueryString("time"),
                money : GetQueryString("money"),
                walletAccount : GetQueryString("walletAccount"),
                operType : GetQueryString("operType"),
                realGiftRate : GetQueryString("realGiftRate"),
                autoUnitPrice : GetQueryString("autoUnitPrice"),
                power_a1 : GetQueryString("power_a1"),
                power_a2 : GetQueryString("power_a2"),
                power_a3 : GetQueryString("power_a3"),
                power_a4 : GetQueryString("power_a4"),
                power_a5 : GetQueryString("power_a5"),
                power_a6 : GetQueryString("power_a6"),
                power_a7 : GetQueryString("power_a7")
            },
            cache : false,
            async : true,// 设置同步方式，false为同步
            success : function(res) {
                if (res.respObj != null && res.respCode == "000000") {
                    socketIsOpen = true;
                    data = res.respObj;
                    $('#power').text(data.power);
                    $('#money').text(data.money/100);
                    power=data.power;
                    serverResultDesc = data.serverResultDesc;
                    money = data.money;
                    $("#showTimes").hide();
                    submit();
                }else{
                    layer.open({
                        content: "功率检测失败..."
                        ,skin: 'msg'
                        ,time: 3 //3秒后自动关闭
                    });
                    window.location="../charging"
                }
            },
            error :function () {
                layer.open({
                    content: "功率检测失败..."
                    ,skin: 'msg'
                    ,time: 3 //3秒后自动关闭
                });
                userIsConfirmed = true;
                window.location="../charging"
            }
        });
    }

    function submit() {

        // console.log("walletAccount: " + walletAccount);
        // console.log("autoPrice: " + autoPrice);
        // console.log("money: " + money);
        // console.log("time: " + time);
        // console.log("realGiftRate: " + realGiftRate);
        // console.log("power_a3: " + power_a3);

        // 会员(选择智能充电)
        if (walletAccount >= autoPrice && time == 800) {
            chargeType = "auto";// 智能充电
            operType = "W";// 会员扣费
            money = autoPrice;
            memCharge();
            return;
        }

        // 会员,但钱包余额不足智能充电单价(选择智能充电)
        if (autoPrice > walletAccount && time == 800) {
            rechargeMoneyToWallet();// 充值钱包
            return;
        }

        // 会员(未选择智能充电)
        if (walletAccount >= autoPrice) {
            chargeType = "charge";// 按功率扣费
            operType = "W";// 会员扣费
            memCharge();
            return;
        }

        // 钱包余额不够支付本次费用,认定为非会员 (未选择智能充电)
        if (walletAccount < money) {
            chargeOrPay();// 充值钱包或者单次支付
            return;
        }

        // 会员,钱包余额小于智能充电单价，只能充电2小时(未选择智能充电)
        chargeTwoHoursOrPay();


    }//submit


    // 会员充电提示
    function memCharge() {
        var msg="";
        if(time == "800"){
            msg="请确认"+devicePort+"插座，充满自停（预设800分钟），预扣费用"+money/100+"元" +
                "点击“确定”后开始充电"
        }else{
            msg="请确认" + devicePort + "插座，会员充电" + time + "分钟；充电费用" + money/100 + "元,点击“确定”后开始充电"
        }

        layer.open({
            content: msg
            ,btn : [ '确定']
            ,yes: function (index) {
                layer.close(index)
                userIsConfirmed = true;
                startCharge4WriteDate();

            }
        })

    }

    // 充值钱包
    function rechargeMoneyToWallet() {

        layer.open({
            content: '亲，余额不足不能使用此功能哦，点击"确定"去充值成为会员后使用此功能...'
            ,btn: [ '确定' ] //[yes no]
            ,yes: function (index) {
                // 跳转到充值页面
                layer.close(index)
                location.href = "../recharge/rechargeNew?companyId=" + companyId;

            }
        })

    }

    // 充值钱包或者单次支付
    function chargeOrPay() {

        layer.open({
            content: '请确认' + devicePort + '插座，充电' + time
            + '分钟；充电费用' + money/100 + '元；点击"临时支付" 支付完成后开始充电，点击"充值" 支付完成后享受会员价格！'
            ,btn: [ '临时支付', '充值' ] //[yes no]
            ,yes: function (index) {
                var pow = power.split("-")[1];
                if(pow*1 > 500){
                    layer.open({
                        content: "临时充电功率超限，请选择会员充电！"
                        ,skin: 'msg'
                        ,time: 3 //3秒后自动关闭
                    });

                    location.href = "../recharge/rechargeNew?companyId=" + companyId;
                    return;
                }
                // 单次支付
                temporaryRechargeMoney(money);
                layer.close(index)
            }
            ,no: function (index) {
                layer.close(index)
                userIsConfirmed = true;
                // 跳转到充值页面
                location.href = "../recharge/rechargeNew?companyId=" + companyId;
            }
        })

    }


    /* 微信支付 */
    function temporaryRechargeMoney(money) {
        $.post("../pay", {
            openId : openId,
            total_fee : LeadBase.encrypts(money.toString()),
        }, function(res) {
            if (res.code == 0) {
                var data = $.parseJSON(res.data);
                if (typeof WeixinJSBridge == "undefined") {
                    if (document.addEventListener) {
                        document.addEventListener('WeixinJSBridgeReady',
                            onBridgeReady(data), false);
                    } else if (document.attachEvent) {
                        document.attachEvent('WeixinJSBridgeReady',
                            onBridgeReady(data));
                        document.attachEvent('onWeixinJSBridgeReady',
                            onBridgeReady(data));
                    }
                } else {
                    onBridgeReady(data);
                }
            } else {
                if (res.code == 2) {
                    layer.alert(res.message);
                } else {
                    layer.open({
                        content: "参数错误：" + res.message
                        ,skin: 'msg'
                        ,time: 3 //3秒后自动关闭
                    });
                }
            }
        });
    }
    function onBridgeReady(json) {
        WeixinJSBridge.invoke('getBrandWCPayRequest', json, function(res) {
            // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回 ok，但并不保证它绝对可靠。
            if (res.err_msg == "get_brand_wcpay_request:ok") {
                chargeType = "temp";// 临时充电收费
                operType = "M";// 微信单次支付
                userIsConfirmed = true;
                startCharge4WriteDate();
            } else {
                layer.open({
                    content: "支付失败"
                    ,skin: 'msg'
                    ,time: 3 //3秒后自动关闭
                });
                userIsConfirmed = true;
                window.location="../charging";

            }
        });
    }


    // 充值钱包或者扣1块充电两小时
    function chargeTwoHoursOrPay() {

        layer.open({
            content: '余额不足，只能充电两小时。请确认' + devicePort + '插座充电' + time
                    +'分钟；点击"充值" 支付完成后享受会员价格，点击"充电" 充电两小时！'
            ,btn: ["充电","充值"] //[yes no]
            ,yes: function (index) {
                layer.close(index)
                chargeType = "charge";// 功率充电
                operType = "W";// 会员扣费
                money = parseInt(device.tow_hours_price);
                time = 120;
                userIsConfirmed = true;
                startCharge4WriteDate();
            }
            ,no: function (index) {
                layer.close(index)
                userIsConfirmed = true;
                location.href = "../recharge/rechargeNew?companyId=" + companyId;
            }
        })

    }
    //开始充电，写数据，发消息
    function startCharge4WriteDate() {
        $.ajax({
            type : 'POST',
            url : "../newDevice/startCharge4WriteDate",
            dataType : "json",
            data : {
                openId : openId,
                companyId : companyId,
                type : chargeType,
                deviceId : deviceId,
                devicePort : devicePort,
                time : time,
                money : money,
                walletAccount : walletAccount,
                operType : operType,
                realGiftRate : realGiftRate,
                autoUnitPrice : autoUnitPrice,
                power_a1 : power_a1,
                power_a2 : power_a2,
                power_a3 : power_a3,
                power_a4 : power_a4,
                power_a5 : power_a5,
                power_a6 : power_a6,
                power_a7 : power_a7,
                power : power,
                serverResultDesc : serverResultDesc
            },
            cache : false,
            async : true,// 设置同步方式，false为同步
            success : function(res) {
                userIsConfirmed = true;

                location.href="../poweroff";
            }
        });

    }

</script>
</html>