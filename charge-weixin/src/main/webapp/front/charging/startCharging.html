<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
<meta name="format-detection" content="telphone=no,email=no" />
<meta name="keywords" content="">
<meta name="description" content="">
<title>我要充电</title>
<link rel="stylesheet" type="text/css" href="temp/main.css">
<script type="text/javascript" src="temp/jquery.js"></script>
<script type="text/javascript" src="js/charging/startCharging.js"></script>
<script src="js/common/layer/layer.js"></script>
<link rel="stylesheet" href="js/common/layer/theme/default/layer.css">
<script type="text/javascript"
	src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">


    var localUrl = window.location.href;
    var openId;
    $(function() {
        openId = localStorage.getItem("openId");// 获取名称为“key”的值
        if (null == openId) {
            getOpenId();
        }
        getJsSdk();
    });
    function getJsSdk() {
        $.ajax({
            type : "POST",
            url : "./scan/getJsSdk",
            data : {
                url : localUrl
            },
            cache : false,
            async : false,//
            dataType : "json",
            success : function(data) {
                wx.config({
                    debug : false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId : data.appId, // 必填，公众号的唯一标识
                    timestamp : data.timestamp, // 必填，生成签名的时间戳
                    nonceStr : data.nonceStr, // 必填，生成签名的随机串
                    signature : data.signature,// 必填，签名，见附录1
                    jsApiList : [ 'scanQRCode' ]
                    // 必填，需要使用的JS接口列表
                });
            }
        });
    }
    // 获取session中的openId
    function getOpenId() {
        $.ajax({
            type : "POST",
            url : "./getOpenId",
            cache : false,// *ie下面只会建立一次 ajax 请求，将响应结果放在浏览器缓存里 下次调用该ajax请求时
            // 从缓存里读取,为false只有ＧＥＴ请求生效
            async : false,// 设置同步方式，false为同步
            dataType : "json",
            success : function(data) {
                if (data.respObj != null && data.respCode == "000000") {
                    openId = data.respObj;
                    localStorage.setItem("openId", data.respObj);// 以“key”为名称存储一个值“value”
                } else {
                    location.href = ".?type=2";
                }
            }
        });
    }

    //扫码查询
    function scanQR() {
        if ($("input[type='checkbox']").is(':checked')) {
            wx.scanQRCode({
                needResult : 1,// 默认为0，扫描结果由微信处理，1则直接返回扫描结果
                desc : 'scanQRCode desc',
                success : function(res) {
                    // 扫码后获取结果参数赋值给Input
					var deviceId = res.resultStr;
					if(res.resultStr.indexOf("deviceid")>=0 && res.resultStr.indexOf("=")>=0 && res.resultStr.indexOf("?")>=0){

                        var strs = res.resultStr.split("=");
                        deviceId = strs[1];
					}

                    if (deviceId.length == 11 || deviceId.length == 12) {
                        //新设备
                        queryNewDevice(deviceId);
                    }else {
                        //老设备
                        queryDevice(deviceId);
                    }


                }
            });
        } else {
            layer.msg("请查看并勾选‘同意《充电说明》’", {
                shift : 5
            });
            return;
        }
    }

    // 扫码查询
    function scanQR1() {
        queryDevice("290000001");

    }


    function queryNewDevice(value) {
        var deviceId;
        if(value.indexOf("deviceid") >=0 && value.indexOf("=")>=0 && value.indexOf("?")>=0 ){
            var strs = value.split("=");
            deviceId = strs[1];
		}

        $.ajax({
            type : 'POST',
            url : "./newDevice/getDeviceInfo",
            dataType : "json",
            data : {
                deviceId : deviceId
            },
            cache : false,
            async : false,
            success : function(data) {
                if (data.respCode != '000000' | null == data.respObj) {
                    layer.msg("设备暂时离线，请稍后再试...", {
                        shift : 5
                    });
                    return;
                }
                location.href = "./charging/chooseNewDevicePortAndTime?deviceId="
                    + data.respObj.id + "&area="
                    + encodeURI(encodeURI(data.respObj.province + data.respObj.city + data.respObj.detail_location)) + "&projectId="
                    + data.respObj.projectId + "&companyId=" + data.respObj.company_id

            },
            error : function() {

            }
        });

    }

    // 查询
    function queryDevice(value) {
        $.ajax({
            type : 'POST',
            url : "./device/queryDeviceInfoByQr",
            dataType : "json",
            data : {
                qr : value
            },
            cache : false,
            async : false,
            success : function(data) {
                if (data.respCode != '000000' | null == data.respObj) {
                    layer.msg("设备暂时离线，请稍后再试...", {
                        shift : 5
                    });
                    return;
                }
                location.href = "./charging/choosePortAndTime?deviceId="
                    + data.respObj.match_num + "&area="
                    + encodeURI(encodeURI(data.respObj.area)) + "&activityId="
                    + data.respObj.activity_id + "&type=" + data.respObj.type

            },
            error : function() {

            }
        });
    }

	
</script>
</head>
<body>

	<div class="top">
		<ul>
			<li><img src="../temp/topNum01.png" alt="1">
				<p>请确保您的充电器插头与充电插座已经连接。</p></li>
			<li><img src="../temp/topNum02.png" alt="2">
				<p>点击扫码充电按钮，扫描充电器已经连接的插座二维码。</p></li>
			<li><img src="../temp/topNum03.png" alt="3">
				<p>选择充电时间付费后开始充电。</p></li>
		</ul>
	</div>
	<div class="cen">
		<div class="terms">
			<input type="checkbox" checked> <a href="./about/mzsm">同意《充电说明》</a>
		</div>
		<i class="icon" onclick="scanQR();"></i>
		<input type="button" onclick="queryNewDevice('http://4009d2a8.nat123.cc?deviceid=10100000001');" value="扫码充电">
	</div>
	<div class="foot">
		<p class="tit">温馨提示</p>
		<ul>
			<li><img src="../temp/footNum01.png" alt="1">
				<p>首次使用请进入公众号“个人中心”-“钱包”立即参与充值送福利活动。</p></li>
			<li><img src="../temp/footNum02.png" alt="2">
				<p>扫码光线不足，请轻触扫码页面手电筒予以补光。</p></li>
			<li><img src="../temp/footNum03.png" alt="3">
				<p>手机信号较差会影响使用，建议在手机信号稳定情况下使用。</p></li>
			<li><img src="../temp/footNum04.png" alt="4">
				<p>使用过程中充电器被拔下或脱落，设备会自动断电。</p></li>
		</ul>
	</div>
</body>
</html>

